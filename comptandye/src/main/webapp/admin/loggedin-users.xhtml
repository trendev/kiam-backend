<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
      xmlns:jsf="http://xmlns.jcp.org/jsf"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
    <h:head>
        <title>Active Session Tracker</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    </h:head>
    <h:body>
        <p>
            <h:outputLink value="index.xhtml">Administration Console</h:outputLink>
        </p>
        <h:form id="sessionform">
            <p:poll interval="#{loggedInUsersBean.refresh}" listener="#{loggedInUsersBean.initLoggedInUsers}" update="sessionform:usertypes sessionform:connections sessionform:loggedInUsers sessionform:count"/>

            <h3>Active Session Tracker - <h:outputText id="count" value="#{loggedInUsersBean.userAccounts.size()} Logged User#{loggedInUsersBean.userAccounts.size()>1?'s':''}"/> </h3>

            <p:chart id="usertypes" type="pie" model="#{loggedInUsersBean.userTypes}" style="width:400px;height:300px" />
            <p:chart id="connections" type="line" model="#{loggedInUsersBean.connections}" style="height:300px;"/>

            <p:dataTable id="loggedInUsers" var="user" value="#{loggedInUsersBean.loggedInUsers}"  sortMode="multiple" tableStyle="width:auto">

                <p:column headerText="UserAccounts" sortBy="#{user.email}">
                    <h:outputText value="#{user.email}" />
                </p:column>

                <p:column headerText="Type" sortBy="#{user.type}">
                    <h:outputText value="#{user.type}" />
                </p:column>

                <p:column headerText="Session id" sortBy="#{user.httpSession.id}">
                    <h:outputText value="#{user.httpSession.id}" style="font-weight: bold; float: right" rendered="#{session.id eq user.httpSession.id}"/>
                    <p:commandButton update="@all" actionListener="#{loggedInUsersBean.remove(user.email, user.httpSession)}" value="#{user.httpSession.id}" id="invalidateButton" icon="ui-icon-circle-close" title="Invalidate session #{user.httpSession.id}" rendered="#{session.id ne user.httpSession.id}" style="float: right"/>

                </p:column>

                <p:column headerText="Session creation time" sortBy="#{user.httpSession.creationTime}">
                    <h:outputText value="#{user.httpSession.creationTime}">
                        <f:convertDateTime type="both" dateStyle="short" />
                    </h:outputText>
                </p:column>

                <p:column headerText="Session last access" sortBy="#{user.httpSession.lastAccessedTime}">
                    <h:outputText value="#{user.httpSession.lastAccessedTime}">
                        <f:convertDateTime type="both" dateStyle="short" />
                    </h:outputText>
                </p:column>
            </p:dataTable>
        </h:form>
    </h:body>
</html>


